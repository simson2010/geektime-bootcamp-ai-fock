# Project Alpha - Ticket 管理系统 需求和设计文档

## 1. 项目概述

### 1.1 项目简介

Project Alpha 是一个基于标签的 Ticket 管理工具，旨在提供简洁高效的任务跟踪和分类功能。系统采用现代化的技术栈，提供直观的用户界面和稳定的后端服务。

### 1.2 技术栈

- **数据库**: PostgreSQL
- **后端**: FastAPI (Python)
- **前端**: TypeScript + Vite + Tailwind CSS + Shadcn UI
- **API 通信**: RESTful API

### 1.3 核心特性

- 无需用户认证系统（单用户模式）
- 基于标签的灵活分类系统
- 完整的 Ticket 生命周期管理
- 实时搜索和过滤功能

---

## 2. 功能需求

### 2.1 Ticket 管理

#### 2.1.1 创建 Ticket

- **描述**: 用户可以创建新的 Ticket
- **输入字段**:
  - `title` (必填): Ticket 标题，字符串，最大 255 字符
  - `description` (可选): Ticket 详细描述，文本，最大 10000 字符
  - `tags` (可选): 关联的标签列表
- **验证规则**:
  - 标题不能为空
  - 标题长度在 1-255 字符之间
  - 描述长度不超过 10000 字符
- **默认状态**: 新创建的 Ticket 状态为 `pending`（待完成）

#### 2.1.2 编辑 Ticket

- **描述**: 用户可以修改现有 Ticket 的信息
- **可编辑字段**:
  - `title`: 修改标题
  - `description`: 修改描述
- **验证规则**: 与创建时相同
- **行为**:
  - 保留 Ticket ID
  - 更新修改时间戳
  - 保留原有标签和状态

#### 2.1.3 删除 Ticket

- **描述**: 用户可以永久删除 Ticket
- **行为**:
  - 硬删除（从数据库中永久移除）
  - 同时删除 Ticket 与标签的关联关系
- **确认机制**: 前端需要二次确认以防误删

#### 2.1.4 完成 Ticket

- **描述**: 将 Ticket 标记为已完成
- **状态变更**: `pending` → `completed`
- **行为**:
  - 记录完成时间戳
  - Ticket 在列表中可选择性显示（如置灰或移至底部）

#### 2.1.5 取消完成 Ticket

- **描述**: 将已完成的 Ticket 重新标记为待完成
- **状态变更**: `completed` → `pending`
- **行为**:
  - 清除完成时间戳
  - Ticket 恢复为正常显示状态

### 2.2 标签管理

#### 2.2.1 添加标签到 Ticket

- **描述**: 为 Ticket 关联一个或多个标签
- **行为**:
  - 如果标签不存在，自动创建新标签
  - 支持同时添加多个标签
  - 避免重复添加相同标签
- **标签属性**:
  - `name` (必填): 标签名称，最大 50 字符
  - `color` (自动生成): 标签颜色，用于 UI 展示

#### 2.2.2 从 Ticket 移除标签

- **描述**: 解除 Ticket 与标签的关联
- **行为**:
  - 仅删除关联关系，不删除标签本身
  - 如果标签不再被任何 Ticket 使用，可选择性保留或删除

#### 2.2.3 标签的全局管理

- **创建标签**: 标签在首次使用时自动创建
- **删除标签**: 删除未使用的标签（可选功能）
- **编辑标签**: 修改标签名称或颜色（可选功能）

### 2.3 查询和过滤

#### 2.3.1 按标签过滤 Ticket

- **描述**: 显示包含特定标签的所有 Ticket
- **功能**:
  - 支持单标签过滤
  - 支持多标签过滤（AND/OR 逻辑）
  - 显示每个标签下的 Ticket 数量
- **UI 交互**:
  - 点击标签进行过滤
  - 可同时选择多个标签
  - 清除过滤按钮

#### 2.3.2 按标题搜索 Ticket

- **描述**: 根据标题关键词搜索 Ticket
- **搜索行为**:
  - 模糊搜索（部分匹配）
  - 不区分大小写
  - 实时搜索（输入时自动搜索）
  - 搜索结果高亮匹配的关键词
- **搜索范围**: 仅搜索标题字段

#### 2.3.3 按状态过滤

- **描述**: 根据完成状态筛选 Ticket
- **过滤选项**:
  - 全部 Ticket
  - 仅待完成
  - 仅已完成

### 2.4 列表展示

#### 2.4.1 Ticket 列表视图

- **展示信息**:
  - Ticket 标题
  - 关联的标签（带颜色）
  - 完成状态
  - 创建时间
  - 更新时间（可选）
- **排序方式**:
  - 默认：按创建时间倒序（最新在前）
  - 可选：按更新时间、标题、状态排序
- **视觉效果**:
  - 已完成的 Ticket 使用不同样式（如删除线、置灰）
  - 悬停效果
  - 平滑动画

---

## 3. 数据模型设计

### 3.1 数据库架构

#### 3.1.1 Tickets 表

```sql
CREATE TABLE tickets (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP WITH TIME ZONE,
    CONSTRAINT check_status CHECK (status IN ('pending', 'completed'))
);

CREATE INDEX idx_tickets_status ON tickets(status);
CREATE INDEX idx_tickets_created_at ON tickets(created_at DESC);
CREATE INDEX idx_tickets_title ON tickets USING gin(to_tsvector('english', title));
```

**字段说明**:

- `id`: 主键，自增整数
- `title`: Ticket 标题，必填
- `description`: Ticket 描述，可选
- `status`: 状态，枚举值 ('pending', 'completed')
- `created_at`: 创建时间，自动设置
- `updated_at`: 更新时间，自动更新
- `completed_at`: 完成时间，仅在状态为 completed 时设置

#### 3.1.2 Tags 表

```sql
CREATE TABLE tags (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    color VARCHAR(7) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_tags_name ON tags(name);
```

**字段说明**:

- `id`: 主键，自增整数
- `name`: 标签名称，唯一
- `color`: 标签颜色，十六进制格式 (#RRGGBB)
- `created_at`: 创建时间

#### 3.1.3 Ticket_Tags 关联表

```sql
CREATE TABLE ticket_tags (
    ticket_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ticket_id, tag_id),
    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);

CREATE INDEX idx_ticket_tags_ticket_id ON ticket_tags(ticket_id);
CREATE INDEX idx_ticket_tags_tag_id ON ticket_tags(tag_id);
```

**字段说明**:

- `ticket_id`: Ticket ID，外键
- `tag_id`: Tag ID，外键
- `created_at`: 关联创建时间
- 联合主键确保同一个 Ticket 不会重复添加同一个标签

### 3.2 数据库触发器

#### 3.2.1 自动更新 updated_at

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_tickets_updated_at
    BEFORE UPDATE ON tickets
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

#### 3.2.2 自动设置 completed_at

```sql
CREATE OR REPLACE FUNCTION set_completed_at()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.status = 'completed' AND OLD.status != 'completed' THEN
        NEW.completed_at = CURRENT_TIMESTAMP;
    ELSIF NEW.status = 'pending' AND OLD.status = 'completed' THEN
        NEW.completed_at = NULL;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_set_completed_at
    BEFORE UPDATE ON tickets
    FOR EACH ROW
    EXECUTE FUNCTION set_completed_at();
```

---

## 4. API 设计

### 4.1 API 约定

- **基础 URL**: `/api/v1`
- **响应格式**: JSON
- **状态码**:
  - 200: 成功
  - 201: 创建成功
  - 204: 删除成功（无内容）
  - 400: 请求参数错误
  - 404: 资源未找到
  - 500: 服务器错误

### 4.2 Ticket 端点

#### 4.2.1 获取所有 Tickets

```
GET /api/v1/tickets
```

**查询参数**:

- `status` (可选): 过滤状态 ('pending', 'completed', 'all')
- `tag_ids` (可选): 标签 ID 列表，逗号分隔
- `search` (可选): 搜索关键词
- `sort_by` (可选): 排序字段 ('created_at', 'updated_at', 'title')
- `order` (可选): 排序方向 ('asc', 'desc')
- `limit` (可选): 返回数量限制
- `offset` (可选): 偏移量（分页）

**响应示例**:

```json
{
  "tickets": [
    {
      "id": 1,
      "title": "实现用户登录功能",
      "description": "需要实现基于 JWT 的用户认证",
      "status": "pending",
      "tags": [
        {
          "id": 1,
          "name": "backend",
          "color": "#3B82F6"
        },
        {
          "id": 2,
          "name": "high-priority",
          "color": "#EF4444"
        }
      ],
      "created_at": "2025-11-10T10:00:00Z",
      "updated_at": "2025-11-10T10:00:00Z",
      "completed_at": null
    }
  ],
  "total": 1,
  "limit": 50,
  "offset": 0
}
```

#### 4.2.2 获取单个 Ticket

```
GET /api/v1/tickets/{ticket_id}
```

**路径参数**:

- `ticket_id`: Ticket ID

**响应**: 单个 Ticket 对象

#### 4.2.3 创建 Ticket

```
POST /api/v1/tickets
```

**请求体**:

```json
{
  "title": "实现用户登录功能",
  "description": "需要实现基于 JWT 的用户认证",
  "tag_ids": [1, 2]
}
```

**响应**: 创建的 Ticket 对象（状态码 201）

#### 4.2.4 更新 Ticket

```
PUT /api/v1/tickets/{ticket_id}
```

**请求体**:

```json
{
  "title": "更新后的标题",
  "description": "更新后的描述"
}
```

**响应**: 更新后的 Ticket 对象

#### 4.2.5 删除 Ticket

```
DELETE /api/v1/tickets/{ticket_id}
```

**响应**: 状态码 204（无内容）

#### 4.2.6 完成 Ticket

```
PATCH /api/v1/tickets/{ticket_id}/complete
```

**响应**: 更新后的 Ticket 对象

#### 4.2.7 取消完成 Ticket

```
PATCH /api/v1/tickets/{ticket_id}/uncomplete
```

**响应**: 更新后的 Ticket 对象

### 4.3 标签端点

#### 4.3.1 获取所有标签

```
GET /api/v1/tags
```

**响应示例**:

```json
{
  "tags": [
    {
      "id": 1,
      "name": "backend",
      "color": "#3B82F6",
      "ticket_count": 5,
      "created_at": "2025-11-10T10:00:00Z"
    }
  ],
  "total": 1
}
```

#### 4.3.2 创建标签

```
POST /api/v1/tags
```

**请求体**:

```json
{
  "name": "frontend",
  "color": "#10B981"
}
```

**响应**: 创建的标签对象（状态码 201）

- 如果 color 未提供，自动生成随机颜色

#### 4.3.3 添加标签到 Ticket

```
POST /api/v1/tickets/{ticket_id}/tags
```

**请求体**:

```json
{
  "tag_ids": [1, 2, 3]
}
```

或者自动创建新标签:

```json
{
  "tag_names": ["backend", "urgent"]
}
```

**响应**: 更新后的 Ticket 对象

#### 4.3.4 从 Ticket 移除标签

```
DELETE /api/v1/tickets/{ticket_id}/tags/{tag_id}
```

**响应**: 状态码 204

---

## 5. 前端设计

### 5.1 页面结构

#### 5.1.1 主页面布局

```
+----------------------------------------------------------+
|                        Header                             |
|  [Logo] [Search Bar]                    [New Ticket Btn] |
+----------------------------------------------------------+
|          |                                                 |
|  Sidebar |              Ticket List                       |
|          |                                                 |
|  Filters |  +------------------------------------------+  |
|          |  | Ticket Title              [Edit] [Delete]|  |
|  [ ] All |  | Description preview                      |  |
|  [ ] To  |  | [Tag1] [Tag2]                            |  |
|      Do  |  | Created: 2025-11-10                      |  |
|  [ ] Done|  +------------------------------------------+  |
|          |  +------------------------------------------+  |
|  Tags:   |  | Another Ticket            [Edit] [Delete]|  |
|  [Tag1]  |  | ...                                      |  |
|  [Tag2]  |  +------------------------------------------+  |
|          |                                                 |
+----------------------------------------------------------+
```

### 5.2 主要组件

#### 5.2.1 TicketList 组件

- **功能**: 展示 Ticket 列表
- **Props**:
  - `tickets`: Ticket 数组
  - `onEdit`: 编辑回调
  - `onDelete`: 删除回调
  - `onToggleComplete`: 完成状态切换回调
- **状态**:
  - 加载状态
  - 错误状态
  - 空状态

#### 5.2.2 TicketCard 组件

- **功能**: 单个 Ticket 的卡片展示
- **Props**:
  - `ticket`: Ticket 对象
  - `onEdit`: 编辑回调
  - `onDelete`: 删除回调
  - `onToggleComplete`: 完成状态切换回调
- **交互**:
  - 点击展开详情
  - 拖拽重新排序（可选）
  - 快速完成按钮

#### 5.2.3 TicketForm 组件

- **功能**: 创建/编辑 Ticket 的表单
- **模式**:
  - 创建模式：空表单
  - 编辑模式：预填充数据
- **字段**:
  - 标题输入框（必填）
  - 描述文本域（可选）
  - 标签选择器（多选）
- **验证**:
  - 实时验证
  - 错误提示
  - 提交前验证

#### 5.2.4 TagSelector 组件

- **功能**: 标签选择器
- **特性**:
  - 下拉多选
  - 搜索标签
  - 创建新标签（输入不存在的标签名）
  - 颜色预览
- **UI**: 使用 Shadcn 的 Combobox 或 Multi-Select 组件

#### 5.2.5 TagBadge 组件

- **功能**: 标签徽章展示
- **Props**:
  - `tag`: 标签对象
  - `removable`: 是否可移除
  - `onRemove`: 移除回调
- **样式**: 使用标签颜色作为背景

#### 5.2.6 SearchBar 组件

- **功能**: 搜索输入框
- **特性**:
  - 防抖处理（300ms）
  - 清除按钮
  - 搜索图标
  - 键盘快捷键（Ctrl/Cmd + K）

#### 5.2.7 FilterSidebar 组件

- **功能**: 过滤侧边栏
- **内容**:
  - 状态过滤器（全部/待完成/已完成）
  - 标签列表（带 Ticket 计数）
  - 清除所有过滤按钮
- **交互**:
  - 单选/多选标签
  - 实时更新列表

#### 5.2.8 ConfirmDialog 组件

- **功能**: 确认对话框
- **用途**: 删除 Ticket 时的二次确认
- **UI**: 使用 Shadcn 的 AlertDialog 组件

### 5.3 状态管理

#### 5.3.1 全局状态（使用 Zustand 或 Context）

```typescript
interface AppState {
  // Tickets
  tickets: Ticket[];
  isLoading: boolean;
  error: string | null;

  // Tags
  tags: Tag[];

  // Filters
  statusFilter: 'all' | 'pending' | 'completed';
  selectedTagIds: number[];
  searchQuery: string;

  // Actions
  fetchTickets: () => Promise<void>;
  createTicket: (data: CreateTicketData) => Promise<void>;
  updateTicket: (id: number, data: UpdateTicketData) => Promise<void>;
  deleteTicket: (id: number) => Promise<void>;
  toggleComplete: (id: number) => Promise<void>;

  fetchTags: () => Promise<void>;
  addTagToTicket: (ticketId: number, tagIds: number[]) => Promise<void>;
  removeTagFromTicket: (ticketId: number, tagId: number) => Promise<void>;

  setStatusFilter: (status: 'all' | 'pending' | 'completed') => void;
  setSelectedTagIds: (ids: number[]) => void;
  setSearchQuery: (query: string) => void;
}
```

### 5.4 UI/UX 设计要点

#### 5.4.1 响应式设计

- **移动端**（< 768px）:
  - 隐藏侧边栏，使用抽屉式菜单
  - 堆叠布局
  - 简化卡片信息
- **平板**（768px - 1024px）:
  - 收缩侧边栏
  - 两列布局
- **桌面**（> 1024px）:
  - 完整侧边栏
  - 三列布局（可选）

#### 5.4.2 交互反馈

- **加载状态**: Skeleton 占位符
- **操作反馈**: Toast 通知（成功/失败）
- **动画**:
  - 列表项进入/退出动画
  - 完成状态过渡动画
  - 标签添加/移除动画
- **空状态**: 友好的空状态提示和插图

#### 5.4.3 键盘快捷键

- `Ctrl/Cmd + K`: 聚焦搜索框
- `N`: 创建新 Ticket
- `Esc`: 关闭对话框/清除搜索
- `↑/↓`: 导航 Ticket 列表
- `Enter`: 编辑选中的 Ticket
- `Del`: 删除选中的 Ticket

#### 5.4.4 颜色方案

- **主色**: Tailwind 的 blue-600
- **成功**: green-600
- **警告**: yellow-500
- **错误**: red-600
- **灰度**: slate 系列
- **标签颜色**: 预定义调色板 + 随机生成

---

## 6. 后端设计

### 6.1 项目结构

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI 应用入口
│   ├── config.py            # 配置文件
│   ├── database.py          # 数据库连接
│   ├── models/
│   │   ├── __init__.py
│   │   ├── ticket.py        # Ticket 模型
│   │   └── tag.py           # Tag 模型
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── ticket.py        # Ticket Pydantic 模型
│   │   └── tag.py           # Tag Pydantic 模型
│   ├── api/
│   │   ├── __init__.py
│   │   ├── tickets.py       # Ticket 路由
│   │   └── tags.py          # Tag 路由
│   ├── crud/
│   │   ├── __init__.py
│   │   ├── ticket.py        # Ticket CRUD 操作
│   │   └── tag.py           # Tag CRUD 操作
│   └── utils/
│       ├── __init__.py
│       └── color_generator.py  # 颜色生成工具
├── tests/
│   ├── __init__.py
│   ├── test_tickets.py
│   └── test_tags.py
├── alembic/                 # 数据库迁移
│   ├── versions/
│   └── env.py
├── requirements.txt
├── .env.example
└── README.md
```

### 6.2 核心模块

#### 6.2.1 数据库连接 (database.py)

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from .config import settings

engine = create_engine(settings.DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

#### 6.2.2 配置管理 (config.py)

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    DATABASE_URL: str
    API_V1_PREFIX: str = "/api/v1"
    PROJECT_NAME: str = "Ticket Management System"

    class Config:
        env_file = ".env"

settings = Settings()
```

#### 6.2.3 SQLAlchemy 模型

**Ticket Model** (models/ticket.py):

```python
from sqlalchemy import Column, Integer, String, Text, DateTime, Enum
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from ..database import Base
import enum

class TicketStatus(str, enum.Enum):
    PENDING = "pending"
    COMPLETED = "completed"

class Ticket(Base):
    __tablename__ = "tickets"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(255), nullable=False)
    description = Column(Text)
    status = Column(Enum(TicketStatus), default=TicketStatus.PENDING, nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    completed_at = Column(DateTime(timezone=True))

    tags = relationship("Tag", secondary="ticket_tags", back_populates="tickets")
```

**Tag Model** (models/tag.py):

```python
from sqlalchemy import Column, Integer, String, DateTime, Table, ForeignKey
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from ..database import Base

ticket_tags = Table(
    'ticket_tags',
    Base.metadata,
    Column('ticket_id', Integer, ForeignKey('tickets.id', ondelete='CASCADE'), primary_key=True),
    Column('tag_id', Integer, ForeignKey('tags.id', ondelete='CASCADE'), primary_key=True),
    Column('created_at', DateTime(timezone=True), server_default=func.now())
)

class Tag(Base):
    __tablename__ = "tags"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50), unique=True, nullable=False, index=True)
    color = Column(String(7), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())

    tickets = relationship("Ticket", secondary=ticket_tags, back_populates="tags")
```

#### 6.2.4 Pydantic Schemas

**Ticket Schemas** (schemas/ticket.py):

```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import Optional, List
from .tag import TagResponse

class TicketBase(BaseModel):
    title: str = Field(..., min_length=1, max_length=255)
    description: Optional[str] = Field(None, max_length=10000)

class TicketCreate(TicketBase):
    tag_ids: Optional[List[int]] = []

class TicketUpdate(BaseModel):
    title: Optional[str] = Field(None, min_length=1, max_length=255)
    description: Optional[str] = Field(None, max_length=10000)

class TicketResponse(TicketBase):
    id: int
    status: str
    tags: List[TagResponse]
    created_at: datetime
    updated_at: Optional[datetime]
    completed_at: Optional[datetime]

    class Config:
        from_attributes = True

class TicketListResponse(BaseModel):
    tickets: List[TicketResponse]
    total: int
    limit: int
    offset: int
```

**Tag Schemas** (schemas/tag.py):

```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import Optional

class TagBase(BaseModel):
    name: str = Field(..., min_length=1, max_length=50)
    color: Optional[str] = Field(None, pattern="^#[0-9A-Fa-f]{6}$")

class TagCreate(TagBase):
    pass

class TagResponse(TagBase):
    id: int
    created_at: datetime
    ticket_count: Optional[int] = 0

    class Config:
        from_attributes = True

class TagListResponse(BaseModel):
    tags: List[TagResponse]
    total: int
```

#### 6.2.5 CRUD 操作

**Ticket CRUD** (crud/ticket.py):

```python
from sqlalchemy.orm import Session
from typing import List, Optional
from ..models.ticket import Ticket, TicketStatus
from ..schemas.ticket import TicketCreate, TicketUpdate

def get_tickets(
    db: Session,
    status: Optional[str] = None,
    tag_ids: Optional[List[int]] = None,
    search: Optional[str] = None,
    skip: int = 0,
    limit: int = 100
) -> List[Ticket]:
    query = db.query(Ticket)

    if status and status != "all":
        query = query.filter(Ticket.status == status)

    if tag_ids:
        query = query.join(Ticket.tags).filter(Tag.id.in_(tag_ids))

    if search:
        query = query.filter(Ticket.title.ilike(f"%{search}%"))

    return query.order_by(Ticket.created_at.desc()).offset(skip).limit(limit).all()

def get_ticket(db: Session, ticket_id: int) -> Optional[Ticket]:
    return db.query(Ticket).filter(Ticket.id == ticket_id).first()

def create_ticket(db: Session, ticket: TicketCreate) -> Ticket:
    db_ticket = Ticket(
        title=ticket.title,
        description=ticket.description
    )
    db.add(db_ticket)
    db.commit()
    db.refresh(db_ticket)

    if ticket.tag_ids:
        tags = db.query(Tag).filter(Tag.id.in_(ticket.tag_ids)).all()
        db_ticket.tags = tags
        db.commit()
        db.refresh(db_ticket)

    return db_ticket

def update_ticket(db: Session, ticket_id: int, ticket: TicketUpdate) -> Optional[Ticket]:
    db_ticket = get_ticket(db, ticket_id)
    if not db_ticket:
        return None

    if ticket.title is not None:
        db_ticket.title = ticket.title
    if ticket.description is not None:
        db_ticket.description = ticket.description

    db.commit()
    db.refresh(db_ticket)
    return db_ticket

def delete_ticket(db: Session, ticket_id: int) -> bool:
    db_ticket = get_ticket(db, ticket_id)
    if not db_ticket:
        return False

    db.delete(db_ticket)
    db.commit()
    return True

def complete_ticket(db: Session, ticket_id: int) -> Optional[Ticket]:
    db_ticket = get_ticket(db, ticket_id)
    if not db_ticket:
        return None

    db_ticket.status = TicketStatus.COMPLETED
    db.commit()
    db.refresh(db_ticket)
    return db_ticket

def uncomplete_ticket(db: Session, ticket_id: int) -> Optional[Ticket]:
    db_ticket = get_ticket(db, ticket_id)
    if not db_ticket:
        return None

    db_ticket.status = TicketStatus.PENDING
    db.commit()
    db.refresh(db_ticket)
    return db_ticket
```

#### 6.2.6 API 路由

**Ticket Routes** (api/tickets.py):

```python
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import List, Optional
from ..database import get_db
from ..schemas.ticket import TicketCreate, TicketUpdate, TicketResponse, TicketListResponse
from ..crud import ticket as crud

router = APIRouter(prefix="/tickets", tags=["tickets"])

@router.get("", response_model=TicketListResponse)
def list_tickets(
    status: Optional[str] = Query(None),
    tag_ids: Optional[str] = Query(None),
    search: Optional[str] = Query(None),
    skip: int = Query(0, ge=0),
    limit: int = Query(50, ge=1, le=100),
    db: Session = Depends(get_db)
):
    tag_id_list = [int(id) for id in tag_ids.split(",")] if tag_ids else None
    tickets = crud.get_tickets(db, status, tag_id_list, search, skip, limit)
    total = len(tickets)  # In production, use count query

    return {
        "tickets": tickets,
        "total": total,
        "limit": limit,
        "offset": skip
    }

@router.get("/{ticket_id}", response_model=TicketResponse)
def get_ticket(ticket_id: int, db: Session = Depends(get_db)):
    ticket = crud.get_ticket(db, ticket_id)
    if not ticket:
        raise HTTPException(status_code=404, detail="Ticket not found")
    return ticket

@router.post("", response_model=TicketResponse, status_code=201)
def create_ticket(ticket: TicketCreate, db: Session = Depends(get_db)):
    return crud.create_ticket(db, ticket)

@router.put("/{ticket_id}", response_model=TicketResponse)
def update_ticket(
    ticket_id: int,
    ticket: TicketUpdate,
    db: Session = Depends(get_db)
):
    updated_ticket = crud.update_ticket(db, ticket_id, ticket)
    if not updated_ticket:
        raise HTTPException(status_code=404, detail="Ticket not found")
    return updated_ticket

@router.delete("/{ticket_id}", status_code=204)
def delete_ticket(ticket_id: int, db: Session = Depends(get_db)):
    success = crud.delete_ticket(db, ticket_id)
    if not success:
        raise HTTPException(status_code=404, detail="Ticket not found")

@router.patch("/{ticket_id}/complete", response_model=TicketResponse)
def complete_ticket(ticket_id: int, db: Session = Depends(get_db)):
    ticket = crud.complete_ticket(db, ticket_id)
    if not ticket:
        raise HTTPException(status_code=404, detail="Ticket not found")
    return ticket

@router.patch("/{ticket_id}/uncomplete", response_model=TicketResponse)
def uncomplete_ticket(ticket_id: int, db: Session = Depends(get_db)):
    ticket = crud.uncomplete_ticket(db, ticket_id)
    if not ticket:
        raise HTTPException(status_code=404, detail="Ticket not found")
    return ticket
```

### 6.3 错误处理

#### 6.3.1 自定义异常

```python
class TicketNotFoundError(Exception):
    pass

class TagNotFoundError(Exception):
    pass

class DuplicateTagError(Exception):
    pass
```

#### 6.3.2 全局异常处理器

```python
from fastapi import Request, status
from fastapi.responses import JSONResponse

@app.exception_handler(TicketNotFoundError)
async def ticket_not_found_handler(request: Request, exc: TicketNotFoundError):
    return JSONResponse(
        status_code=status.HTTP_404_NOT_FOUND,
        content={"detail": "Ticket not found"}
    )
```

### 6.4 中间件

#### 6.4.1 CORS 配置

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],  # Vite dev server
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

#### 6.4.2 日志中间件

```python
import logging
import time

@app.middleware("http")
async def log_requests(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time

    logging.info(
        f"{request.method} {request.url.path} - "
        f"Status: {response.status_code} - "
        f"Duration: {process_time:.4f}s"
    )

    return response
```

---

## 7. 部署方案

### 7.1 开发环境

#### 7.1.1 后端开发

```bash
# 安装依赖
pip install -r requirements.txt

# 设置环境变量
cp .env.example .env

# 运行数据库迁移
alembic upgrade head

# 启动开发服务器
uvicorn app.main:app --reload --port 8000
```

#### 7.1.2 前端开发

```bash
# 安装依赖
yarn

# 启动开发服务器
yarn dev
```

### 7.2 生产环境

#### 7.2.1 本地 Postgres 数据库

直接使用本地 Postgres 数据库，数据库名称为 projectalpha，用户名称为 postgres，密码为 postgres。

#### 7.2.2 环境变量

```env
# Database
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/projectalpha

# API
API_V1_PREFIX=/api/v1
PROJECT_NAME=Project Alpha

# CORS
ALLOWED_ORIGINS=http://localhost:5173
```

---

## 8. 测试策略

### 8.1 后端测试

#### 8.1.1 单元测试

- 测试 CRUD 操作
- 测试数据验证
- 测试业务逻辑

#### 8.1.2 集成测试

- 测试 API 端点
- 测试数据库交互
- 测试完整的请求-响应流程

#### 8.1.3 测试工具

- pytest
- pytest-asyncio
- httpx（用于测试 FastAPI）

### 8.2 前端测试

#### 8.2.1 单元测试

- 测试组件渲染
- 测试用户交互
- 测试状态管理

#### 8.2.2 集成测试

- 测试 API 调用
- 测试路由
- 测试完整用户流程

#### 8.2.3 E2E 测试

- 使用 Playwright 或 Cypress
- 测试关键用户路径

#### 8.2.4 测试工具

- Vitest
- React Testing Library
- Playwright

---

## 9. 性能优化

### 9.1 后端优化

- **数据库索引**: 在常用查询字段上创建索引
- **查询优化**: 使用 JOIN 避免 N+1 查询
- **连接池**: 配置合适的数据库连接池大小
- **缓存**: 对标签列表等静态数据使用 Redis 缓存

### 9.2 前端优化

- **代码拆分**: 使用 Vite 的动态导入
- **懒加载**: 图片和组件懒加载
- **虚拟滚动**: 大列表使用虚拟滚动
- **防抖节流**: 搜索和过滤使用防抖
- **缓存**: 使用 React Query 或 SWR 缓存 API 请求

---

## 10. 安全考虑

### 10.1 输入验证

- 前后端都进行输入验证
- 防止 SQL 注入（使用 ORM）
- 防止 XSS 攻击（React 自动转义）

### 10.2 API 安全

- 设置合理的请求频率限制
- 验证请求来源（CORS）
- 使用 HTTPS（生产环境）

---

## 11. 未来扩展

### 11.1 可选功能

- **优先级**: 为 Ticket 添加优先级字段
- **截止日期**: 添加到期时间提醒
- **附件**: 支持文件上传
- **评论**: Ticket 评论功能
- **历史记录**: 查看 Ticket 修改历史
- **批量操作**: 批量完成、删除、添加标签
- **导出**: 导出 Ticket 为 CSV/JSON
- **统计**: 数据统计和可视化面板
- **标签层级**: 支持父子标签关系
- **暗黑模式**: 支持明暗主题切换

### 11.2 技术演进

- 添加用户认证系统
- 多用户协作功能
- 实时更新（WebSocket）
- 移动端应用
- PWA 支持

---

## 12. 开发时间估算

### 12.1 后端开发（约 3-4 天）

- 数据库设计和迁移: 0.5 天
- 模型和 Schema 定义: 0.5 天
- CRUD 操作实现: 1 天
- API 路由实现: 1 天
- 测试和调试: 1 天

### 12.2 前端开发（约 4-5 天）

- 项目搭建和配置: 0.5 天
- 基础组件开发: 1 天
- Ticket 管理功能: 1.5 天
- 标签管理功能: 1 天
- 搜索和过滤功能: 0.5 天
- UI/UX 优化: 0.5 天
- 测试和调试: 1 天

### 12.3 总计

- **总开发时间**: 约 7-9 天
- **测试和优化**: 2-3 天
- **文档和部署**: 1 天
- **项目总时长**: 10-13 天

---

## 13. 交付物

### 13.1 代码

- 完整的后端代码
- 完整的前端代码
- 数据库迁移脚本

### 13.2 文档

- API 文档（Swagger/OpenAPI）
- 部署指南
- 用户使用手册
- 开发者指南

### 13.3 测试

- 单元测试
- 集成测试
- 测试覆盖率报告

---

## 附录 A: 技术栈详细信息

### A.1 后端技术栈

- **Python**: 3.11+（使用 uv）
- **FastAPI**: 0.104+
- **SQLAlchemy**: 2.0+
- **Pydantic**: 2.0+
- **Alembic**: 数据库迁移工具
- **Uvicorn**: ASGI 服务器
- **PostgreSQL**: 17+

### A.2 前端技术栈

- **TypeScript**: 5.0+
- **React**: 19+
- **Vite**: 7.0+
- **Tailwind CSS**: 4+
- **Shadcn UI**: 最新版
- **React Query**: 数据获取和缓存
- **Zustand**: 状态管理
- **React Router**: 路由管理

---

## 附录 B: 颜色预设

### B.1 标签颜色预设

```typescript
const TAG_COLORS = [
  '#EF4444', // red-500
  '#F59E0B', // amber-500
  '#10B981', // emerald-500
  '#3B82F6', // blue-500
  '#8B5CF6', // violet-500
  '#EC4899', // pink-500
  '#6366F1', // indigo-500
  '#14B8A6', // teal-500
];
```

---

## 附录 C: 数据库初始化脚本

```sql
-- 创建数据库
CREATE DATABASE projectalpha;

-- 连接到数据库
\c projectalpha;

-- 创建表（由 Alembic 迁移自动生成）

-- 插入示例数据
INSERT INTO tags (name, color) VALUES
  ('backend', '#3B82F6'),
  ('frontend', '#10B981'),
  ('urgent', '#EF4444'),
  ('bug', '#F59E0B'),
  ('feature', '#8B5CF6');

INSERT INTO tickets (title, description, status) VALUES
  ('实现用户登录功能', '需要实现基于 JWT 的用户认证', 'pending'),
  ('修复导航栏样式问题', '移动端导航栏显示异常', 'pending'),
  ('添加数据导出功能', '支持导出为 CSV 格式', 'completed');

-- 添加标签关联
INSERT INTO ticket_tags (ticket_id, tag_id) VALUES
  (1, 1), -- backend
  (1, 3), -- urgent
  (2, 2), -- frontend
  (2, 4), -- bug
  (3, 1); -- backend
```

---

**文档版本**: 1.0
**创建日期**: 2025-11-10
**最后更新**: 2025-11-10
**作者**: AI Assistant
**状态**: 完成
